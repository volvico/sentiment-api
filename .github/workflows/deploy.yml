## Ã‰tape 9 : CrÃ©er le workflow GitHub Actions

GitHub Actions permet d'automatiser le processus de dÃ©ploiement. Chaque fois que vous pushez du code, GitHub Actions va :
1. Installer les dÃ©pendances
2. ExÃ©cuter les tests
3. DÃ©clencher le dÃ©ploiement sur Render

**CrÃ©ez le fichier `.github/workflows/deploy.yml` avec ce contenu** :

```yaml
# ============================================
# ğŸš€ WORKFLOW DE DÃ‰PLOIEMENT AUTOMATIQUE
# ============================================
# Ce fichier configure GitHub Actions pour tester, builder et dÃ©ployer automatiquement
# l'API sur Render Ã  chaque push sur la branche main.
#
# Workflow en 3 Ã©tapes : TEST â†’ BUILD â†’ DEPLOY

name: Deploy API

# ============================================
# DÃ‰CLENCHEURS DU WORKFLOW
# ============================================
# Le workflow se lance automatiquement quand :
on:
  push:
    branches: [ main ]      # Ã€ chaque push sur la branche main
  pull_request:
    branches: [ main ]      # Ã€ chaque Pull Request vers main (pour tester avant merge)

# ============================================
# JOBS (TÃ¢ches Ã  exÃ©cuter)
# ============================================
# Les jobs s'exÃ©cutent dans l'ordre : test â†’ build â†’ deploy

jobs:
  # ==========================================
  # JOB 1 : TESTS ğŸ§ª
  # ==========================================
  # VÃ©rifie que le code fonctionne correctement avant de continuer
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest      # Utilise une machine Ubuntu virtuelle
    
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©rer le code du repository
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3    # Action GitHub officielle pour rÃ©cupÃ©rer le code
      
      # Ã‰tape 2 : Installer Python
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'     # Version de Python Ã  utiliser
          cache: 'pip'               # Met en cache les dÃ©pendances pip pour aller plus vite
      
      # Ã‰tape 3 : Installer les dÃ©pendances nÃ©cessaires
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip        # Met Ã  jour pip
          pip install -r requirements.txt            # Installe FastAPI et uvicorn
          pip install pytest httpx                   # Installe les outils de test
      
      # Ã‰tape 4 : Tester que l'application peut Ãªtre importÃ©e (pas d'erreur de syntaxe)
      - name: âœ… Test import
        run: |
          python -c "from main import app; print('âœ… Import OK')"
      
      # Ã‰tape 5 : Tester les endpoints principaux
      - name: ğŸ§ª Test endpoints
        run: |
          python -c "
          from fastapi.testclient import TestClient
          from main import app
          
          # CrÃ©er un client de test
          client = TestClient(app)
          
          # Test 1 : Page d'accueil
          assert client.get('/').status_code == 200
          
          # Test 2 : Endpoint stats
          r = client.get('/stats')
          assert r.status_code == 200
          assert 'total' in r.json()
          
          # Test 3 : Endpoint binome
          r = client.get('/binome')
          assert r.status_code == 200
          assert 'binome' in r.json()
          
          print('âœ… Tous les tests passent !')
          "

  # ==========================================
  # JOB 2 : BUILD ğŸ—ï¸
  # ==========================================
  # VÃ©rifie que l'application peut Ãªtre construite/compilÃ©e
  build:
    name: ğŸ—ï¸ Build
    needs: test                    # Ce job ne s'exÃ©cute QUE si le job 'test' a rÃ©ussi
    runs-on: ubuntu-latest
    if: github.event_name == 'push'    # S'exÃ©cute uniquement sur push (pas sur PR)
    
    steps:
      # Ã‰tape 1 : RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3
      
      # Ã‰tape 2 : Afficher des informations sur le build
      - name: ğŸ“Š Build info
        run: |
          echo "ğŸ—ï¸ Building application..."
          echo "ğŸ“ Commit: ${{ github.sha }}"           # Hash du commit
          echo "ğŸ‘¤ Author: ${{ github.actor }}"         # Auteur du commit
          echo "ğŸŒ³ Branch: ${{ github.ref_name }}"      # Nom de la branche
      
      # Ã‰tape 3 : Installer Python
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # Ã‰tape 4 : VÃ©rifier que toutes les dÃ©pendances s'installent correctement
      - name: ğŸ“¦ Verify dependencies
        run: |
          pip install -r requirements.txt
          echo "âœ… Dependencies OK"
      
      # Ã‰tape 5 : VÃ©rifier que tous les fichiers nÃ©cessaires sont prÃ©sents
      - name: ğŸ“‹ Check files
        run: |
          ls -la                              # Liste tous les fichiers
          echo "âœ… Files OK"
      
      # Ã‰tape 6 : Build terminÃ© avec succÃ¨s
      - name: âœ… Build complete
        run: |
          echo "âœ… Build successful!"

  # ==========================================
  # JOB 3 : DEPLOY ğŸš€
  # ==========================================
  # DÃ©ploie l'application sur Render (uniquement si TEST et BUILD ont rÃ©ussi)
  deploy:
    name: ğŸš€ Deploy to Render
    needs: [test, build]           # Attend que TEST et BUILD soient terminÃ©s avec succÃ¨s
    runs-on: ubuntu-latest
    # Conditions strictes : dÃ©ploie SEULEMENT si :
    # - On est sur la branche 'main'
    # - C'est un push (pas une pull request)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # Ã‰tape 1 : DÃ©clencher le dÃ©ploiement sur Render
      # Le Deploy Hook est une URL unique fournie par Render
      # Faire un POST sur cette URL dÃ©clenche automatiquement un redÃ©ploiement
      - name: Deploy to Render
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
          # Note : RENDER_DEPLOY_HOOK doit Ãªtre configurÃ© dans les secrets GitHub
          # (Settings â†’ Secrets â†’ Actions â†’ New repository secret)
      
      # Ã‰tape 2 : Confirmation du dÃ©ploiement
      - name: âœ… Deployment complete
        run: |
          echo "âœ… DÃ©ploiement Render terminÃ© !"
          echo "ğŸŒ VÃ©rifiez votre dashboard Render pour le statut"
          echo "ğŸ“± Votre API sera accessible dans quelques minutes"

# ============================================
# RÃ‰SUMÃ‰ DU WORKFLOW
# ============================================
# 1. Chaque push sur 'main' dÃ©clenche le workflow
# 2. JOB TEST : VÃ©rifie que le code fonctionne
# 3. JOB BUILD : VÃ©rifie que l'app peut Ãªtre construite
# 4. JOB DEPLOY : Envoie un signal Ã  Render pour redÃ©ployer
# 5. Render rÃ©cupÃ¨re le code, l'installe et le met en ligne
#
# Si un job Ã©choue, les suivants ne s'exÃ©cutent pas (sÃ©curitÃ©)
# ============================================
```

---
